import { useEffect, useMemo, useRef, useState } from "react";
import { Play, RefreshCw, Music, CheckCircle, XCircle } from "lucide-react";
import classNames from "classnames";
import { SONGS } from "../../data/songs";

type GameState = "idle" | "playing" | "waiting" | "completed";

interface WordSlot {
    id: string;
    core: string;
    suffix: string;
    length: number;
    prefill: string;
    fillableLength: number;
}

const sanitizeLetters = (value: string) => value.replace(/[^A-Za-z']/g, "");

const buildWordSlots = (text: string): WordSlot[] => {
    if (!text.trim()) return [];

    const tokens = text.split(/\s+/).filter(Boolean);
    const slots: WordSlot[] = tokens.map((token, index) => {
        const match = token.match(/^([A-Za-z']+)(.*)$/);
        const core = match ? match[1] : token;
        const suffix = match ? match[2] : "";

        return {
            id: `${index}-${token}`,
            core,
            suffix,
            length: core.length,
            prefill: "",
            fillableLength: core.length
        };
    });

    const candidateIndexes = slots
        .map((slot, idx) => ({ slot, idx }))
        .filter(({ slot }) => slot.length >= 5)
        .sort((a, b) => b.slot.length - a.slot.length)
        .slice(0, 2)
        .map(entry => entry.idx);

    candidateIndexes.forEach(index => {
        const slot = slots[index];
        if (slot) {
            slot.prefill = slot.core.charAt(0) || "";
        }
    });

    return slots.map(slot => ({
        ...slot,
        fillableLength: Math.max(slot.length - (slot.prefill ? 1 : 0), 0)
    }));
};

const assembleWordInputs = (slots: WordSlot[], inputs: string[]) =>
    slots
        .map((slot, index) => {
            if (!slot.length) return slot.core;
            const typedPart = (inputs[index] ?? "").trim();
            const combined = `${slot.prefill ?? ""}${typedPart}`;
            if (!combined.trim()) return "";
            return slot.suffix ? `${combined}${slot.suffix}` : combined;
        })
        .filter(Boolean)
        .join(" ");

export const MusicDemoPage = () => {
    const song = SONGS[0];

    const [gameState, setGameState] = useState<GameState>("idle");
    const [currentPhraseIndex, setCurrentPhraseIndex] = useState(0);
    const [wordInputs, setWordInputs] = useState<string[]>([]);
    const [feedback, setFeedback] = useState<{ type: "correct" | "incorrect" | null; message?: string }>({ type: null });

    const audioRef = useRef<HTMLAudioElement | null>(null);
    const blockRefs = useRef<Array<HTMLInputElement | null>>([]);

    const currentPhrase = song.phrases[currentPhraseIndex];
    const isLastPhrase = currentPhraseIndex === song.phrases.length - 1;
    const isInputLocked = gameState !== "waiting" || feedback.type === "correct";
    const phraseText = currentPhrase?.en ?? "";
    const wordSlots = useMemo(() => buildWordSlots(phraseText), [phraseText]);

    useEffect(() => {
        setWordInputs(wordSlots.map(() => ""));
        blockRefs.current = [];
    }, [wordSlots]);

    const focusBlock = (index: number) => {
        if (index < 0 || index >= wordSlots.length) return;
        if (wordSlots[index]?.fillableLength === 0) return;
        const input = blockRefs.current[index];
        if (input) {
            const position = input.value.length;
            input.focus();
            input.setSelectionRange(position, position);
        }
    };

    const focusFirstWritableBlock = () => {
        for (let i = 0; i < wordSlots.length; i += 1) {
            if (wordSlots[i]?.fillableLength > 0) {
                focusBlock(i);
                break;
            }
        }
    };

    const focusNextBlock = (currentIndex: number) => {
        for (let i = currentIndex + 1; i < wordSlots.length; i += 1) {
            if (wordSlots[i]?.fillableLength > 0) {
                focusBlock(i);
                break;
            }
        }
    };

    const playPhraseAtIndex = (phraseIndex: number) => {
        if (!audioRef.current || !song.phrases[phraseIndex]) return;

        audioRef.current.currentTime = song.phrases[phraseIndex].start / 1000;
        audioRef.current.play().catch(console.error);
        setGameState("playing");
        setFeedback({ type: null });
    };

    const playPhrase = () => {
        playPhraseAtIndex(currentPhraseIndex);
    };

    const handleTimeUpdate = () => {
        if (!audioRef.current || !currentPhrase || gameState !== "playing") return;

        const currentTime = audioRef.current.currentTime * 1000;

        if (currentTime >= currentPhrase.end) {
            audioRef.current.pause();
            setGameState("waiting");
            setTimeout(() => focusFirstWritableBlock(), 80);
        }
    };

    const normalizeText = (text: string) => text.toLowerCase().replace(/[.,!?]/g, "").trim();

    const checkAnswer = () => {
        if (!currentPhrase || !wordSlots.length) return;

        const typedSentence = assembleWordInputs(wordSlots, wordInputs);
        const normalized = normalizeText(typedSentence);
        const expected = normalizeText(currentPhrase.en);

        if (normalized === expected) {
            setFeedback({ type: "correct", message: "Great job! Loading the next clip..." });

            setTimeout(() => {
                if (isLastPhrase) {
                    setGameState("completed");
                } else {
                    const nextIndex = currentPhraseIndex + 1;
                    setCurrentPhraseIndex(nextIndex);
                    setWordInputs([]);
                    setFeedback({ type: null });
                    setTimeout(() => playPhraseAtIndex(nextIndex), 50);
                }
            }, 1200);
        } else {
            setFeedback({ type: "incorrect", message: "Try again and pay attention to every word." });
        }
    };

    const handleWordKeyDown = (e: React.KeyboardEvent<HTMLInputElement>) => {
        if (e.key === "Enter" && !isInputLocked) {
            checkAnswer();
        }
    };

    const handleWordInputChange = (index: number, rawValue: string) => {
        const slot = wordSlots[index];
        if (!slot) return;
        if (slot.fillableLength === 0) return;

        const sanitized = sanitizeLetters(rawValue)
            .slice(0, slot.fillableLength || undefined)
            .toUpperCase();

        setWordInputs(prev => {
            const next = [...prev];
            next[index] = sanitized;
            return next;
        });

        if (slot.fillableLength && sanitized.length >= slot.fillableLength) {
            focusNextBlock(index);
        }
    };

    const resetGame = () => {
        if (audioRef.current) {
            audioRef.current.pause();
            audioRef.current.currentTime = 0;
        }

        setGameState("idle");
        setCurrentPhraseIndex(0);
        setWordInputs([]);
        setFeedback({ type: null });
    };

    const requiredWordCount = wordSlots.filter(slot => slot.fillableLength > 0).length;
    const completedWordCount = wordSlots.filter(
        (slot, index) => slot.fillableLength === 0 || (wordInputs[index]?.length ?? 0) === slot.fillableLength
    ).length;
    const isSubmitDisabled = isInputLocked || !requiredWordCount || completedWordCount !== requiredWordCount;

    const placeholderWords = wordSlots
        .filter(slot => slot.length > 0)
        .map((slot, index) => (
            <span
                key={`${slot.id}-${index}`}
                className="px-3 py-1 rounded-2xl bg-white/60 text-slate-400 text-xs font-semibold tracking-[0.4em] shadow-sm"
            >
                {"_".repeat(Math.min(slot.length || 1, 8))}
            </span>
        ));

    return (
        <div className="relative min-h-screen overflow-hidden bg-[#FFFBF5]">
            <div className="pointer-events-none absolute -top-24 -left-16 h-80 w-80 rounded-full bg-gradient-to-br from-orange-200 via-pink-100 to-yellow-100 opacity-60 blur-[120px]" />
            <div className="pointer-events-none absolute top-1/2 -right-32 h-96 w-96 rounded-full bg-gradient-to-br from-sky-200 via-indigo-100 to-violet-100 opacity-50 blur-[140px]" />
            <audio
                ref={audioRef}
                src={song.audioUrl}
                onTimeUpdate={handleTimeUpdate}
                className="hidden"
            />

            <div className="relative mx-auto flex min-h-screen max-w-4xl flex-col px-4 py-8">
                <header className="mb-6 flex items-center justify-between rounded-[2rem] border border-slate-100 bg-white/90 px-6 py-4 shadow-[0_20px_60px_-15px_rgba(0,0,0,0.12)] backdrop-blur">
                    <div className="flex items-center gap-4">
                        <div className="flex h-12 w-12 items-center justify-center rounded-2xl bg-slate-900 text-white shadow-lg shadow-slate-900/30">
                            <Music className="w-6 h-6" />
                        </div>
                        <div>
                            <p className="text-[11px] font-semibold uppercase tracking-[0.4em] text-slate-400">Lyric Lab</p>
                            <h1 className="text-2xl font-black text-slate-900">{song.title}</h1>
                            <p className="text-sm text-slate-500">{song.artist}</p>
                        </div>
                    </div>
                    <button
                        onClick={resetGame}
                        className="inline-flex items-center gap-2 rounded-full border border-slate-200 px-4 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-slate-600 transition-all hover:border-slate-400 hover:text-slate-900"
                    >
                        <RefreshCw className="w-4 h-4" />
                        重新开始
                    </button>
                </header>

                {gameState === "completed" ? (
                    <div className="flex flex-1 items-center justify-center">
                        <div className="w-full space-y-4 rounded-[3rem] border border-slate-100 bg-white/90 px-6 py-12 text-center shadow-[0_20px_60px_-15px_rgba(0,0,0,0.12)]">
                            <CheckCircle className="mx-auto h-16 w-16 text-emerald-500 animate-pulse" />
                            <h2 className="text-3xl font-black text-slate-900">全部片段完成</h2>
                            <p className="text-base text-slate-500">继续跟着节奏练习一遍，巩固听力与拼写手感。</p>
                            <button
                                onClick={resetGame}
                                className="inline-flex items-center gap-2 rounded-full bg-slate-900 px-6 py-3 text-xs font-semibold uppercase tracking-[0.4em] text-white transition-all hover:scale-105"
                            >
                                <RefreshCw className="w-4 h-4" />
                                再来一次
                            </button>
                        </div>
                    </div>
                ) : (
                    <main className="flex flex-1 flex-col gap-6">
                        <section className="flex flex-col rounded-[3rem] border border-white/70 bg-white/90 px-8 py-6 shadow-[0_20px_60px_-15px_rgba(0,0,0,0.1)]">
                            <div className="flex items-start justify-between gap-4">
                                <div>
                                    <p className="text-[10px] font-semibold uppercase tracking-[0.5em] text-slate-400">Step 01 / Listen</p>
                                    <h3 className="mt-1 text-2xl font-black text-slate-900">
                                        {gameState === "idle" ? "点击播放按钮，先听一次" : gameState === "playing" ? "保持专注，捕捉每个音节" : "轮到你，照节奏补完所有单词"}
                                    </h3>
                                    <p className="mt-2 text-base text-slate-500">{currentPhrase?.zh}</p>
                                </div>
                                <div className="flex flex-col items-end text-xs font-semibold uppercase tracking-[0.4em] text-slate-400">
                                    <span>片段</span>
                                    <span className="text-lg text-slate-900">
                                        {currentPhraseIndex + 1}/{song.phrases.length}
                                    </span>
                                </div>
                            </div>

                            <div className="mt-6 flex flex-1 flex-col items-center justify-center">
                                <button
                                    onClick={playPhrase}
                                    className={classNames(
                                        "group relative flex h-24 w-24 items-center justify-center rounded-full text-white shadow-lg transition-all",
                                        gameState === "playing"
                                            ? "bg-slate-300 cursor-not-allowed"
                                            : "bg-slate-900 hover:scale-105 hover:bg-slate-800"
                                    )}
                                    disabled={gameState === "playing"}
                                >
                                    <Play className="w-8 h-8" />
                                    <span className="absolute -bottom-8 text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
                                        {gameState === "playing" ? "PLAYING" : "PLAY"}
                                    </span>
                                </button>

                                <div className="mt-12 w-full rounded-[2rem] border border-dashed border-slate-200 bg-white/70 px-6 py-6 text-center">
                                    {gameState === "playing" && currentPhrase ? (
                                        <div className="space-y-3">
                                            <p className="text-[11px] font-semibold uppercase tracking-[0.5em] text-slate-400">Now Playing</p>
                                            <p className="text-3xl font-black text-slate-900 leading-snug">{currentPhrase.en}</p>
                                        </div>
                                    ) : (
                                        <div className="space-y-4">
                                            <p className="text-[10px] font-semibold uppercase tracking-[0.6em] text-slate-400">
                                                {gameState === "waiting" ? "YOUR TURN" : "LISTEN FIRST"}
                                            </p>
                                            <div className="flex flex-wrap justify-center gap-3">{placeholderWords}</div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </section>

                        <section className="flex flex-1 flex-col rounded-[3rem] border border-white/70 bg-white/95 px-8 py-6 shadow-[0_20px_60px_-15px_rgba(0,0,0,0.12)]">
                            <div className="flex items-start justify-between gap-4">
                                <div>
                                    <p className="text-[10px] font-semibold uppercase tracking-[0.5em] text-slate-400">Step 02 / Type</p>
                                    <h3 className="mt-1 text-2xl font-black text-slate-900">填完每个块，拼出整句歌词</h3>
                                    <p className="mt-2 text-sm text-slate-500">半辅助会挑出 1-2 个词自动给首字母，其余交给你完成。</p>
                                </div>
                                <button
                                    onClick={checkAnswer}
                                    disabled={isSubmitDisabled}
                                    className={classNames(
                                        "inline-flex items-center gap-2 rounded-full px-6 py-3 text-sm font-semibold uppercase tracking-[0.3em] transition-all",
                                        isSubmitDisabled ? "bg-slate-200 text-slate-400" : "bg-slate-900 text-white hover:scale-105"
                                    )}
                                >
                                    提交
                                </button>
                            </div>

                            <div className="mt-5 flex-1 rounded-[2.5rem] border border-slate-100 bg-white/80 px-5 py-5">
                                {wordSlots.length ? (
                                    <div className="flex flex-wrap gap-4">
                                        {wordSlots.map((slot, index) => (
                                            <div
                                                key={slot.id}
                                                className={classNames(
                                                    "flex min-w-[140px] flex-1 flex-col rounded-[1.5rem] border border-slate-100 bg-white/95 px-4 py-3 shadow-sm transition hover:-translate-y-0.5",
                                                    slot.fillableLength === 0 && !slot.prefill ? "opacity-60" : "opacity-100"
                                                )}
                                            >
                                                <span className="text-[9px] font-semibold uppercase tracking-[0.4em] text-slate-400">块 {index + 1}</span>
                                                <div className="mt-3 flex items-center gap-3">
                                                    <span
                                                        className={classNames(
                                                            "flex h-10 w-10 items-center justify-center rounded-2xl border text-base font-black",
                                                            slot.prefill
                                                                ? "border-indigo-200 bg-indigo-50 text-indigo-500"
                                                                : "border-dashed border-slate-200 text-slate-300"
                                                        )}
                                                    >
                                                        {slot.prefill ? slot.prefill.toUpperCase() : "・"}
                                                    </span>
                                                    <div className="relative flex-1">
                                                        <input
                                                            ref={element => {
                                                                blockRefs.current[index] = element;
                                                            }}
                                                            value={wordInputs[index] ?? ""}
                                                            onChange={event => handleWordInputChange(index, event.target.value)}
                                                            onKeyDown={handleWordKeyDown}
                                                            maxLength={slot.fillableLength || undefined}
                                                            disabled={isInputLocked || slot.fillableLength === 0}
                                                            className={classNames(
                                                                "w-full rounded-[1.5rem] border px-4 py-3 text-center text-2xl font-black tracking-[0.4em] uppercase text-slate-900 outline-none transition",
                                                                isInputLocked || slot.fillableLength === 0
                                                                    ? "border-slate-100 bg-slate-50 text-slate-400"
                                                                    : "border-slate-200 bg-white focus:border-sky-400 focus:ring-4 focus:ring-sky-50"
                                                            )}
                                                        />
                                                        {slot.suffix && (
                                                            <span className="absolute -right-4 top-1/2 -translate-y-1/2 text-base font-semibold text-slate-400">
                                                                {slot.suffix}
                                                            </span>
                                                        )}
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                ) : (
                                    <div className="flex h-full items-center justify-center text-sm text-slate-400">暂无歌词数据</div>
                                )}
                            </div>

                            <div className="mt-5 flex items-center justify-between text-xs font-semibold uppercase tracking-[0.4em] text-slate-500">
                                <span>{Math.min(completedWordCount, requiredWordCount)}/{requiredWordCount} 块已完成</span>
                                <button
                                    type="button"
                                    onClick={playPhrase}
                                    className="inline-flex items-center gap-1 rounded-full border border-slate-200 px-3 py-1 text-[10px] text-slate-600 transition-all hover:border-slate-400 hover:text-slate-900"
                                >
                                    <Play className="w-4 h-4" />
                                    再听
                                </button>
                            </div>

                            {feedback.type && (
                                <div
                                    className={classNames(
                                        "mt-4 flex items-center gap-3 rounded-[2rem] px-5 py-3 text-base font-semibold",
                                        feedback.type === "correct"
                                            ? "bg-emerald-50 border border-emerald-200 text-emerald-900"
                                            : "bg-rose-50 border border-rose-200 text-rose-900"
                                    )}
                                >
                                    {feedback.type === "correct" ? (
                                        <CheckCircle className="h-6 w-6 text-emerald-500" />
                                    ) : (
                                        <XCircle className="h-6 w-6 text-rose-500" />
                                    )}
                                    <span>{feedback.message}</span>
                                </div>
                            )}
                        </section>
                    </main>
                )}
            </div>
        </div>
    );
};

export default MusicDemoPage;
