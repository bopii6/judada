generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider          = "postgresql"
  url               = env("DATABASE_URL")
  directUrl         = env("DIRECT_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

model User {
  id                     String                 @id
  email                  String?                @unique
  name                   String?
  avatarUrl              String?
  createdAt              DateTime               @default(now())
  updatedAt              DateTime               @updatedAt
  deletedAt              DateTime?
  auditTrails            AuditTrail[]
  createdPackages        CoursePackage[]        @relation("PackageCreator")
  createdVersions        CoursePackageVersion[] @relation("PackageVersionCreator")
  reviewedVersions       CoursePackageVersion[] @relation("PackageVersionReviewer")
  jobs                   GenerationJob[]        @relation("JobTrigger")
  createdLessons         Lesson[]               @relation("LessonCreator")
  createdLessonVersions  LessonVersion[]        @relation("LessonVersionCreator")
  reviewedLessonVersions LessonVersion[]        @relation("LessonVersionReviewer")
  notifications          Notification[]
  reviewedReviews        Review[]               @relation("ReviewReviewer")
  submittedReviews       Review[]               @relation("ReviewSubmitter")
  userAchievements       UserAchievement[]
  userDailyLogs          UserDailyLog[]
  userProgress           UserProgress[]
  roles                  UserRole[]
  userStats              UserStats?
}

model Role {
  id        String     @id @default(uuid())
  name      String     @unique
  label     String
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  userRoles UserRole[]
}

model UserRole {
  userId     String
  roleId     String
  assignedAt DateTime @default(now())
  role       Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
}

model CoursePackage {
  id               String                 @id @default(uuid())
  title            String
  topic            String
  description      String?
  coverUrl         String?
  grade            String?                // 年级：如 "1", "2", "3"... "初一", "高一"
  publisher        String?                // 出版社：如 "人教版", "北师大版", "外研社版"
  semester         String?                // 学期：如 "上册", "下册"
  status           CourseStatus           @default(draft)
  createdById      String?
  currentVersionId String?                @unique
  createdAt        DateTime               @default(now())
  updatedAt        DateTime               @updatedAt
  deletedAt        DateTime?
  assets           Asset[]
  createdBy        User?                  @relation("PackageCreator", fields: [createdById], references: [id])
  currentVersion   CoursePackageVersion?  @relation("PackageCurrentVersion", fields: [currentVersionId], references: [id])
  versions         CoursePackageVersion[]
  jobs             GenerationJob[]
  lessons          Lesson[]
  units            Unit[]                 // 课程包下的单元列表

  @@index([status])
  @@index([grade])
  @@index([publisher])
}

// 单元模型 - 课程包下的章节/单元
model Unit {
  id          String       @id @default(uuid())
  packageId   String
  sequence    Int          // 单元序号：1, 2, 3...
  title       String       // 单元标题：如 "Unit 1: Hello"
  description String?      // 单元简介
  coverUrl    String?      // 单元封面
  status      CourseStatus @default(draft)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  deletedAt   DateTime?
  package     CoursePackage @relation(fields: [packageId], references: [id], onDelete: Cascade)
  lessons     Lesson[]     // 单元下的关卡列表
  jobs        GenerationJob[] @relation("UnitJobs")

  @@unique([packageId, sequence])
  @@index([packageId])
  @@index([status])
}

model CoursePackageVersion {
  id                String                 @id @default(uuid())
  packageId         String
  versionNumber     Int
  label             String?
  status            VersionStatus          @default(draft)
  sourceType        SourceType             @default(manual_input)
  notes             String?
  payload           Json?
  previousVersionId String?
  createdById       String?
  reviewedById      String?
  createdAt         DateTime               @default(now())
  updatedAt         DateTime               @updatedAt
  publishedAt       DateTime?
  reviewDecidedAt   DateTime?
  deletedAt         DateTime?
  assets            Asset[]
  currentForPackage CoursePackage?         @relation("PackageCurrentVersion")
  createdBy         User?                  @relation("PackageVersionCreator", fields: [createdById], references: [id])
  package           CoursePackage          @relation(fields: [packageId], references: [id], onDelete: Cascade)
  previousVersion   CoursePackageVersion?  @relation("PackageVersionHistory", fields: [previousVersionId], references: [id])
  nextVersions      CoursePackageVersion[] @relation("PackageVersionHistory")
  reviewedBy        User?                  @relation("PackageVersionReviewer", fields: [reviewedById], references: [id])
  jobs              GenerationJob[]
  lessons           Lesson[]               @relation("PackageVersionLessons")
  reviews           Review[]

  @@unique([packageId, versionNumber])
  @@index([status])
}

model Lesson {
  id               String                @id @default(uuid())
  packageId        String
  packageVersionId String?
  unitId           String?               // 所属单元ID
  title            String
  sequence         Int                   // 在单元内的序号
  unitNumber       Int?                  // 单元序号（冗余字段，方便查询）
  unitName         String?               // 单元名称（冗余字段，方便查询）
  status           CourseStatus          @default(draft)
  currentVersionId String?               @unique
  createdById      String?
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt
  deletedAt        DateTime?
  createdBy        User?                 @relation("LessonCreator", fields: [createdById], references: [id])
  currentVersion   LessonVersion?        @relation("LessonCurrentVersion", fields: [currentVersionId], references: [id])
  package          CoursePackage         @relation(fields: [packageId], references: [id], onDelete: Cascade)
  packageVersion   CoursePackageVersion? @relation("PackageVersionLessons", fields: [packageVersionId], references: [id])
  unit             Unit?                 @relation(fields: [unitId], references: [id], onDelete: SetNull)
  versions         LessonVersion[]

  @@unique([packageId, sequence])
  @@index([packageId])
  @@index([unitId])
  @@index([packageId, unitNumber])
  @@index([status])
}

model LessonVersion {
  id                String          @id @default(uuid())
  lessonId          String
  versionNumber     Int
  title             String
  summary           String?
  difficulty        Int?
  status            VersionStatus   @default(draft)
  previousVersionId String?
  createdById       String?
  reviewedById      String?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  publishedAt       DateTime?
  reviewDecidedAt   DateTime?
  deletedAt         DateTime?
  currentForLesson  Lesson?         @relation("LessonCurrentVersion")
  items             LessonItem[]
  createdBy         User?           @relation("LessonVersionCreator", fields: [createdById], references: [id])
  lesson            Lesson          @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  previousVersion   LessonVersion?  @relation("LessonVersionHistory", fields: [previousVersionId], references: [id])
  nextVersions      LessonVersion[] @relation("LessonVersionHistory")
  reviewedBy        User?           @relation("LessonVersionReviewer", fields: [reviewedById], references: [id])

  @@unique([lessonId, versionNumber])
  @@index([status])
}

model LessonItem {
  id              String         @id @default(uuid())
  lessonVersionId String
  orderIndex      Int
  type            LessonItemType
  title           String?
  payload         Json
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  lessonVersion   LessonVersion  @relation(fields: [lessonVersionId], references: [id], onDelete: Cascade)

  @@unique([lessonVersionId, orderIndex])
  @@index([lessonVersionId])
}

model Asset {
  id               String                @id @default(uuid())
  packageId        String?
  packageVersionId String?
  storagePath      String
  originalName     String
  mimeType         String?
  fileSize         Int?
  sourceType       SourceType            @default(pdf_upload)
  metadata         Json?
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt
  deletedAt        DateTime?
  package          CoursePackage?        @relation(fields: [packageId], references: [id])
  packageVersion   CoursePackageVersion? @relation(fields: [packageVersionId], references: [id])

  @@index([packageId])
  @@index([packageVersionId])
}

model MusicTrack {
  id               String           @id @default(uuid())
  title            String
  titleCn          String?
  slug             String           @unique
  artist           String?
  description      String?
  coverUrl         String?
  status           MusicTrackStatus @default(draft)
  durationMs       Int?
  audioStoragePath String
  audioMimeType    String?
  audioFileSize    Int?
  words            Json?
  phrases          Json?
  metadata         Json?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  publishedAt      DateTime?

  @@index([status])
}

model GenerationJob {
  id               String                @id @default(uuid())
  jobType          JobType
  status           JobStatus             @default(queued)
  packageId        String?
  packageVersionId String?
  unitId           String?               // 关联的单元ID
  triggeredById    String?
  sourceType       SourceType?
  inputInfo        Json?
  progress         Int?                  @default(0)
  result           Json?
  errorMessage     String?
  startedAt        DateTime?             @default(now())
  completedAt      DateTime?
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt
  package          CoursePackage?        @relation(fields: [packageId], references: [id])
  packageVersion   CoursePackageVersion? @relation(fields: [packageVersionId], references: [id])
  unit             Unit?                 @relation("UnitJobs", fields: [unitId], references: [id])
  triggeredBy      User?                 @relation("JobTrigger", fields: [triggeredById], references: [id])
  logs             JobLog[]

  @@index([status])
  @@index([jobType])
  @@index([unitId])
}

model JobLog {
  id        String        @id @default(uuid())
  jobId     String
  level     JobLogLevel   @default(info)
  message   String
  details   Json?
  createdAt DateTime      @default(now())
  job       GenerationJob @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([jobId])
}

model Review {
  id               String               @id @default(uuid())
  packageVersionId String
  status           ReviewStatus         @default(pending)
  submittedById    String?
  reviewedById     String?
  notes            String?
  createdAt        DateTime             @default(now())
  decidedAt        DateTime?
  packageVersion   CoursePackageVersion @relation(fields: [packageVersionId], references: [id], onDelete: Cascade)
  reviewedBy       User?                @relation("ReviewReviewer", fields: [reviewedById], references: [id])
  submittedBy      User?                @relation("ReviewSubmitter", fields: [submittedById], references: [id])

  @@index([status])
}

model Notification {
  id        String           @id @default(uuid())
  userId    String
  type      NotificationType @default(system)
  payload   Json?
  readAt    DateTime?
  createdAt DateTime         @default(now())
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, type])
}

model AuditTrail {
  id          String   @id @default(uuid())
  entityType  String
  entityId    String
  action      String
  changes     Json?
  performedBy String?
  createdAt   DateTime @default(now())
  user        User?    @relation(fields: [performedBy], references: [id])

  @@index([entityType, entityId])
}

model EmailVerification {
  id        String             @id @default(uuid())
  email     String
  code      String
  status    VerificationStatus @default(pending)
  attempts  Int                @default(0)
  expiresAt DateTime
  createdAt DateTime           @default(now())

  @@unique([email, code])
  @@index([email])
  @@index([expiresAt])
}

model UserProgress {
  id           String       @id @default(uuid())
  userId       String
  stageId      String
  courseId     String
  bestStars    Int          @default(0)
  attempts     Int          @default(0)
  lastPlayedAt DateTime     @default(now())
  modes        LessonMode[]
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, stageId])
  @@index([userId])
  @@index([courseId])
}

model UserDailyLog {
  id              String   @id @default(uuid())
  userId          String
  date            String
  completedStages Int      @default(0)
  starsEarned     Int      @default(0)
  typingStages    Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([userId])
}

model UserAchievement {
  id         String   @id @default(uuid())
  userId     String
  type       String
  data       Json?
  unlockedAt DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, type])
  @@index([userId])
}

model UserStats {
  id              String   @id @default(uuid())
  userId          String   @unique
  totalPlayTime   Int      @default(0)
  totalStars      Int      @default(0)
  completedStages Int      @default(0)
  currentStreak   Int      @default(0)
  longestStreak   Int      @default(0)
  lastActiveAt    DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

enum CourseStatus {
  draft
  pending_review
  published
  archived
}

enum VersionStatus {
  draft
  pending_review
  published
  archived
}

enum SourceType {
  pdf_upload
  image_ocr
  manual_input
  ai_generated
  mixed
}

enum LessonItemType {
  vocabulary
  phrase
  sentence
  dialogue
  quiz_single_choice
  quiz_multiple_choice
  fill_blank
  reorder
  listening
  speaking
  writing
  custom
}

enum VerificationStatus {
  pending
  verified
  expired
}

enum JobType {
  package_generation
  lesson_generation
  asset_processing
  content_review
}

enum JobStatus {
  queued
  processing
  succeeded
  failed
  canceled
}

enum JobLogLevel {
  info
  warning
  error
}

enum ReviewStatus {
  pending
  approved
  rejected
  changes_requested
}

enum NotificationType {
  job_completed
  review_submitted
  review_decision
  version_published
  system
}

enum MusicTrackStatus {
  draft
  processing
  published
  archived
}

enum LessonMode {
  tiles
  type
}
