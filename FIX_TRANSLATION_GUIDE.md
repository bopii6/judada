# 🔧 修复翻译数据指南

## 📋 问题诊断

根据日志分析，**所有历史关卡**都存在以下问题：
- `payload.cn` 字段存储的是摘要（summary）内容
- 而不是真正的英文句子翻译

例如：
- **英文句子**: `"Monday What do you have on Fridays?"`
- **当前显示**: `"针对主题核心词汇进行理解与记忆"` (这是摘要)
- **应该显示**: `"星期一，你星期五有什么课？"` (真正的翻译)

## ✅ 已完成的修复

1. ✅ 修复了代码问题：
   - Worker 不再将 `summary` 错误保存到 `payload.cn`
   - 新生成的关卡将正确存储翻译

2. ✅ 添加了详细日志：
   - 可以清楚看到哪些关卡有问题
   - 可以追踪数据读取流程

## 🔨 修复历史数据

### 方式一：使用批量修复脚本（推荐）

我已经创建了一个自动化修复脚本，它会：
1. 扫描所有有问题的关卡
2. 为每个关卡生成正确的中文翻译
3. 更新数据库中的 `payload.cn` 字段

**运行步骤：**

```bash
# 1. 确保服务器已构建
cd apps/server
pnpm build

# 2. 运行修复脚本
node fix-translation-data.js
```

**脚本功能：**
- 🔍 自动扫描所有有问题的关卡
- 🤖 使用 AI 生成正确的中文翻译
- 💾 自动更新数据库
- 📊 显示修复进度和统计

**注意事项：**
- 脚本会调用翻译 API，可能需要一些时间
- 每个关卡之间会有 1 秒延迟，避免 API 限流
- 运行前会显示问题列表，确认后才会开始修复

### 方式二：手动编辑修复

如果关卡数量不多，可以手动修复：

1. 打开管理后台
2. 进入课程包页面
3. 对每个有问题的关卡：
   - 点击「编辑」按钮
   - 在「中文翻译」字段输入正确的中文翻译
   - 点击「保存」

## 📊 从日志看到的问题

根据你提供的日志，所有关卡都显示：
```
isCnSameAsSummary: '⚠️ 警告：cn 等于 summary!'
```

这说明：
- **所有历史关卡都需要修复**
- 从日志可以看到至少有 48+ 个关卡需要修复

## 🎯 建议操作步骤

1. **先确认代码修复已生效**（已完成 ✅）
   - Worker 不再生成错误的翻译
   - 新生成的关卡应该是正确的

2. **运行批量修复脚本**（推荐）
   ```bash
   cd apps/server
   pnpm build
   node fix-translation-data.js
   ```

3. **验证修复结果**
   - 刷新管理后台页面
   - 检查关卡的中文翻译是否显示正确
   - 查看服务器日志，确认不再有警告

## ⚠️ 重要提示

- **运行修复脚本前，建议先备份数据库**
- 脚本会调用 AI 翻译 API，可能需要一些时间
- 如果关卡很多（>100个），可能需要分批运行
- 修复完成后，新生成的关卡将自动正确存储翻译

## 🆘 如果遇到问题

如果修复脚本运行时遇到问题：
1. 检查数据库连接
2. 检查翻译 API 配置（Hunyuan）
3. 查看错误日志
4. 可以尝试先修复少量关卡测试

---

**修复脚本位置**: `apps/server/fix-translation-data.js`






