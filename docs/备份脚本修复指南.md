# 🔧 备份脚本权限修复指南

## ❌ 问题分析
您遇到的错误：
```
mkdir: cannot create directory '/root': Permission denied
```

**原因**：当前用户不是root，无法访问/root目录

## ✅ 解决方案

### 方案1：使用当前用户目录（推荐）

将备份目录改为当前用户的home目录：

```bash
# 创建备份目录（使用当前用户）
mkdir -p ~/backup/$(date +%Y%m%d)
cd ~/backup/$(date +%Y%m%d)

# 后续所有操作都使用这个目录
```

### 方案2：切换到root用户

```bash
# 切换到root用户
sudo su -

# 然后执行备份命令
mkdir -p /root/backup/$(date +%Y%m%d)
cd /root/backup/$(date +%Y%m%d)

# 备份完成后退出root
exit
```

## 🛠️ 修正后的备份命令

### 完整备份脚本（使用当前用户目录）

```bash
# 1. 创建备份目录
mkdir -p ~/backup/$(date +%Y%m%d)
cd ~/backup/$(date +%Y%m%d)

# 2. 备份应用代码（使用sudo读取系统文件）
sudo tar -czf judada-code.tar.gz -C /var/www judada

# 3. 备份Nginx配置
sudo cp -r /etc/nginx nginx-config

# 4. 备份PM2配置
sudo cp -r /home/admin/.pm2 pm2-config  # 根据实际用户调整

# 5. 备份环境变量文件
sudo cp /var/www/judada/.env .env-backup

# 6. 备份SSL证书（如果有）
sudo cp -r /etc/letsencrypt ssl-certificates

# 7. 备份脚本文件
sudo cp /var/www/judada/*.sh .

# 8. 记录当前运行的进程
pm2 status > pm2-status.txt
ps aux > running-processes.txt

# 9. 显示备份文件列表
ls -la

# 10. 显示备份目录大小
du -sh .
```

### 权限问题排查

```bash
# 检查当前用户
whoami

# 检查当前目录
pwd

# 检查是否有sudo权限
sudo whoami

# 查看系统用户列表
cat /etc/passwd | grep -E '(root|admin)'

# 查看当前用户组
groups
```

## 🔍 检查应用位置

```bash
# 查找应用实际安装位置
sudo find / -name "judada" -type d 2>/dev/null

# 或者查找常见的web目录
ls -la /var/www/
ls -la /home/
ls -la /opt/

# 检查当前运行的web服务
sudo netstat -tlnp | grep -E ':(80|443|4000|5173)'

# 查找Node.js进程
ps aux | grep node
```

## 📝 根据实际情况调整路径

根据您的实际用户和安装位置，可能需要调整以下路径：

1. **应用目录**：
   - `/var/www/judada` → 可能是其他位置
   - `/home/admin/judada` → 用户目录下
   - `/opt/judada` → opt目录下

2. **PM2配置**：
   - `/root/.pm2` → root用户配置
   - `/home/admin/.pm2` → admin用户配置

3. **环境变量**：
   - `/var/www/judada/.env` → 可能需要调整

## 🚀 快速诊断脚本

运行这个脚本来快速诊断系统状态：

```bash
#!/bin/bash
echo "=== 系统诊断脚本 ==="
echo "当前用户: $(whoami)"
echo "当前目录: $(pwd)"
echo "Home目录: $HOME"
echo ""

echo "=== 检查sudo权限 ==="
if sudo -n true 2>/dev/null; then
    echo "✅ 有sudo权限"
else
    echo "❌ 没有sudo权限"
fi
echo ""

echo "=== 查找应用目录 ==="
echo "搜索judada目录："
sudo find / -name "*judada*" -type d 2>/dev/null | head -10
echo ""

echo "=== 检查Node.js进程 ==="
ps aux | grep node | grep -v grep
echo ""

echo "=== 检查web服务端口 ==="
sudo netstat -tlnp | grep -E ':(80|443|4000|5173)' | head -10
echo ""

echo "=== 检查常见安装目录 ==="
for dir in /var/www /home /opt /usr/local; do
    if [ -d "$dir" ]; then
        echo "检查 $dir:"
        ls -la "$dir" | grep -i judada || echo "  未找到judada相关文件"
    fi
done
```

保存为 `diagnose.sh` 并运行：
```bash
chmod +x diagnose.sh
./diagnose.sh
```

## 📞 获取帮助

如果遇到问题，请提供以下信息：

1. **当前用户信息**：
   ```bash
   whoami
   id
   groups
   ```

2. **应用实际位置**：
   ```bash
   sudo find / -name "*judada*" 2>/dev/null
   ```

3. **错误信息**：
   完整的错误输出

4. **系统信息**：
   ```bash
   uname -a
   cat /etc/os-release
   ```

---

**建议**：先运行诊断脚本了解系统状态，然后根据实际情况调整备份路径。