# 🚀 阿里云到腾讯云服务器迁移指南

## 📋 迁移概览

### 🔄 迁移流程
1. **准备阶段**：备份阿里云服务器数据
2. **新服务器配置**：配置腾讯云服务器
3. **数据迁移**：迁移代码和配置
4. **服务部署**：在腾讯云重新部署
5. **域名切换**：更新DNS解析
6. **清理工作**：关闭阿里云服务器

### ⏱️ 预计时间
- 总计：2-3小时
- 备份：30分钟
- 新服务器配置：1小时
- 部署测试：1小时

## 🔍 第一步：备份阿里云服务器

### 1.1 连接阿里云服务器
```bash
# SSH连接到阿里云服务器
ssh root@阿里云服务器IP
```

### 1.2 备份重要数据
```bash
# 创建备份目录
mkdir -p /root/backup/$(date +%Y%m%d)
cd /root/backup/$(date +%Y%m%d)

# 备份应用代码
tar -czf judada-code.tar.gz /var/www/judada

# 备份Nginx配置
cp -r /etc/nginx nginx-config

# 备份PM2配置
pm2 save
cp -r /root/.pm2 pm2-config

# 备份环境变量文件
cp /var/www/judada/.env .env-backup

# 备份SSL证书（如果有）
cp -r /etc/letsencrypt ssl-certificates

# 备份脚本文件
cp /var/www/judada/*.sh .

# 记录当前运行的进程
pm2 status > pm2-status.txt
ps aux > running-processes.txt

# 显示备份文件列表
ls -la
```

### 1.3 下载备份到本地
```bash
# 在本地电脑运行（新开一个终端）
# 使用scp下载备份文件
scp -r root@阿里云服务器IP:/root/backup/$(date +%Y%m%d) ./

# 或者使用rsync
rsync -avz root@阿里云服务器IP:/root/backup/$(date +%Y%m%d)/ ./
```

### 1.4 记录关键配置信息
创建一个配置记录文件 `migration-config.txt`：

```txt
=== 阿里云服务器信息 ===
IP地址: 阿里云服务器IP
系统版本: Ubuntu 20.04
域名: your-domain.com

=== 数据库信息 ===
DATABASE_URL: (记录当前的数据库连接字符串)
Supabase项目ID: (如果使用Supabase)

=== API密钥 ===
OPENAI_API_KEY: (记录当前使用的密钥)
TENCENT_SECRET_ID: (记录当前使用的密钥)
TENCENT_SECRET_KEY: (记录当前使用的密钥)
ADMIN_KEY: (记录管理员密钥)

=== SSL证书信息 ===
证书域名: your-domain.com
证书到期日: (查看证书信息)
证书路径: /etc/letsencrypt/live/your-domain.com/

=== 端口配置 ===
后端端口: 4000
前端端口: 5173
Nginx端口: 80, 443
```

## 🛠️ 第二步：配置腾讯云服务器

### 2.1 腾讯云服务器基础配置
```bash
# SSH连接到腾讯云服务器
ssh root@腾讯云服务器IP

# 更新系统
sudo apt update && sudo apt upgrade -y

# 设置时区
sudo timedatectl set-timezone Asia/Shanghai

# 安装基础工具
sudo apt install -y curl wget git nano htop unzip
```

### 2.2 安装Node.js
```bash
# 安装Node.js 18.x
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# 验证安装
node --version
npm --version

# 安装pnpm
npm install -g pnpm
pnpm --version
```

### 2.3 安装PM2
```bash
# 安装PM2进程管理器
sudo npm install -g pm2

# 设置PM2开机自启
pm2 startup
```

### 2.4 安装Nginx
```bash
# 安装Nginx
sudo apt install -y nginx

# 启动并设置开机自启
sudo systemctl start nginx
sudo systemctl enable nginx

# 检查Nginx状态
sudo systemctl status nginx
```

### 2.5 配置防火墙
```bash
# 配置UFW防火墙
sudo ufw --force reset
sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw allow ssh
sudo ufw allow 'Nginx Full'
sudo ufw --force enable

# 检查防火墙状态
sudo ufw status
```

### 2.6 腾讯云安全组配置
在腾讯云控制台：
1. 进入轻量应用服务器管理
2. 点击"防火墙"
3. 添加规则：
   - 端口：22，协议：TCP，来源：0.0.0.0/0
   - 端口：80，协议：TCP，来源：0.0.0.0/0
   - 端口：443，协议：TCP，来源：0.0.0.0/0

## 📦 第三步：迁移应用代码

### 3.1 创建应用目录
```bash
# 创建应用目录
sudo mkdir -p /var/www/judada
sudo chown -R $USER:$USER /var/www/judada
cd /var/www/judada
```

### 3.2 上传代码到腾讯云服务器

**方法1：使用Git克隆**
```bash
# 克隆代码
git clone https://github.com/bopii6/judada.git .

# 切换到当前部署的分支
git checkout main
```

**方法2：使用scp上传本地代码**
```bash
# 在本地电脑运行
scp -r ./judada/* root@腾讯云服务器IP:/var/www/judada/
```

### 3.3 恢复环境配置
```bash
# 创建环境变量文件
cp .env.example .env

# 编辑环境变量文件
nano .env
```

填入之前记录的配置信息：
```env
# 数据库
DATABASE_URL=your-database-url

# API密钥
OPENAI_API_KEY=your-openai-key
TENCENT_SECRET_ID=your-tencent-secret-id
TENCENT_SECRET_KEY=your-tencent-secret-key

# 基础配置
PORT=4000
NODE_ENV=production
ADMIN_KEY=your-admin-key

# Supabase配置
SUPABASE_URL=your-supabase-url
SUPABASE_ANON_KEY=your-supabase-anon-key
SUPABASE_SERVICE_ROLE_KEY=your-supabase-service-role-key
SUPABASE_STORAGE_BUCKET=your-supabase-bucket

# Redis配置
REDIS_URL=redis://localhost:6379

# 队列配置
QUEUE_PREFIX=course-gen

# OpenAI配置
OPENAI_MODEL_NAME=gpt-4.1-mini
```

## 🚀 第四步：部署应用

### 4.1 安装依赖并构建
```bash
# 进入项目目录
cd /var/www/judada

# 安装依赖
pnpm install

# 构建项目
pnpm build
```

### 4.2 配置Nginx
```bash
# 创建Nginx站点配置
sudo nano /etc/nginx/sites-available/judada
```

粘贴以下配置：
```nginx
server {
    listen 80;
    server_name _;  # 或者你的域名

    # 前端静态文件
    location / {
        root /var/www/judada/apps/web/dist;
        try_files $uri $uri/ /index.html;

        # 缓存静态资源
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }

    # API代理
    location /api {
        proxy_pass http://localhost:4000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # 管理后台
    location /admin {
        proxy_pass http://localhost:5174;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}
```

启用站点配置：
```bash
# 启用站点
sudo ln -s /etc/nginx/sites-available/judada /etc/nginx/sites-enabled/

# 删除默认站点
sudo rm /etc/nginx/sites-enabled/default

# 测试Nginx配置
sudo nginx -t

# 重启Nginx
sudo systemctl restart nginx
```

### 4.3 启动应用服务
```bash
# 启动后端服务
cd /var/www/judada/apps/server
pm2 start dist/index.js --name "judada-server"

# 启动管理后台（如果需要）
cd /var/www/judada/apps/admin
pm2 start dist --name "judada-admin" --spa

# 保存PM2配置
pm2 save

# 查看服务状态
pm2 status
```

### 4.4 测试应用
```bash
# 检查服务状态
curl http://localhost:4000/api/health

# 检查网站访问
curl -I http://腾讯云服务器IP
```

在浏览器中访问：`http://腾讯云服务器IP`

## 🔐 第五步：配置SSL证书

### 5.1 安装Certbot
```bash
# 安装Certbot
sudo apt install -y certbot python3-certbot-nginx

# 申请SSL证书
sudo certbot --nginx -d your-domain.com
```

### 5.2 配置自动续期
```bash
# 添加自动续期任务
sudo crontab -e
```

添加以下内容：
```bash
0 12 * * * /usr/bin/certbot renew --quiet
```

## 🌐 第六步：域名解析切换

### 6.1 更新DNS记录
在你的域名提供商（如阿里云万网、腾讯云等）：

1. **删除A记录**：
   - 删除指向阿里云服务器IP的A记录

2. **添加新的A记录**：
   - 主机记录：@（或www）
   - 记录类型：A
   - 记录值：腾讯云服务器IP
   - TTL：600（或更低）

3. **等待DNS生效**：
   ```bash
   # 检查DNS解析
   nslookup your-domain.com
   dig your-domain.com
   ```

### 6.2 验证域名切换
```bash
# 检查域名是否指向新服务器
curl -H "Host: your-domain.com" http://腾讯云服务器IP

# 测试HTTPS访问
curl -I https://your-domain.com
```

## 🔧 第七步：最终配置和优化

### 7.1 设置日志轮转
```bash
# 创建日志目录
sudo mkdir -p /var/log/judada

# 配置logrotate
sudo nano /etc/logrotate.d/judada
```

添加以下内容：
```
/var/log/judada/*.log {
    daily
    missingok
    rotate 52
    compress
    notifempty
    create 644 www-data www-data
    postrotate
        systemctl reload nginx
    endscript
}
```

### 7.2 配置监控脚本
创建监控脚本：
```bash
# 创建监控脚本
sudo nano /usr/local/bin/judada-monitor.sh
```

```bash
#!/bin/bash
# Jude English Lab 监控脚本

# 检查后端服务
if ! pm2 list | grep -q "judada-server.*online"; then
    echo "$(date): 后端服务异常，尝试重启" >> /var/log/judada/monitor.log
    pm2 restart judada-server
fi

# 检查Nginx服务
if ! systemctl is-active --quiet nginx; then
    echo "$(date): Nginx服务异常，尝试重启" >> /var/log/judada/monitor.log
    systemctl restart nginx
fi

# 检查磁盘空间
DISK_USAGE=$(df / | awk 'NR==2 {print $5}' | sed 's/%//')
if [ $DISK_USAGE -gt 80 ]; then
    echo "$(date): 磁盘使用率过高: ${DISK_USAGE}%" >> /var/log/judada/monitor.log
fi
```

设置执行权限：
```bash
sudo chmod +x /usr/local/bin/judada-monitor.sh

# 添加定时监控任务
sudo crontab -e
```

添加监控任务：
```bash
*/5 * * * * /usr/local/bin/judada-monitor.sh
```

## 🧹 第八步：清理阿里云服务器

### 8.1 备份确认
确保所有重要数据已备份：
```bash
# 确认备份文件完整性
ls -la /root/backup/$(date +%Y%m%d)
```

### 8.2 停止服务
```bash
# 在阿里云服务器上
pm2 stop all
sudo systemctl stop nginx
```

### 8.3 释放资源
在阿里云控制台：
1. 停止或释放轻量应用服务器
2. 取消绑定的域名（如果有）
3. 删除相关的快照和镜像（可选）

## ✅ 迁移完成检查清单

### 📋 检查清单
- [ ] 腾讯云服务器基础配置完成
- [ ] 应用代码成功部署
- [ ] 环境变量配置正确
- [ ] Nginx配置并运行正常
- [ ] 后端服务PM2管理正常
- [ ] SSL证书安装成功
- [ ] 域名DNS解析指向新服务器
- [ ] 网站HTTP和HTTPS访问正常
- [ ] API接口响应正常
- [ ] 管理后台访问正常
- [ ] 监控脚本运行正常
- [ ] 日志轮转配置完成
- [ ] 阿里云服务器备份确认
- [ ] 阿里云服务器资源释放

### 🎯 测试项目
1. **网站访问测试**：
   - 主页：https://your-domain.com
   - 管理后台：https://your-domain.com/admin
   - API健康检查：https://your-domain.com/api/health

2. **功能测试**：
   - 用户登录/注册
   - 课程浏览
   - 文件上传
   - OCR功能

3. **性能测试**：
   - 页面加载速度
   - API响应时间
   - 服务器资源使用情况

## 🆘 常见问题解决

### Q: 域名解析未生效
```bash
# 清除本地DNS缓存
# Windows
ipconfig /flushdns

# macOS
sudo dscacheutil -flushcache

# Linux
sudo systemctl restart systemd-resolved

# 使用nslookup检查
nslookup your-domain.com 8.8.8.8
```

### Q: SSL证书申请失败
```bash
# 检查域名解析
dig your-domain.com

# 检查80端口是否可访问
curl -I http://your-domain.com

# 手动申请证书
sudo certbot certonly --standalone -d your-domain.com
```

### Q: 后端服务无法启动
```bash
# 检查端口占用
sudo netstat -tlnp | grep :4000

# 查看PM2日志
pm2 logs judada-server

# 手动启动测试
cd /var/www/judada/apps/server
node dist/index.js
```

### Q: Nginx配置错误
```bash
# 测试配置文件
sudo nginx -t

# 查看错误日志
sudo tail -f /var/log/nginx/error.log

# 重新加载配置
sudo nginx -s reload
```

## 📞 技术支持

- **腾讯云工单**：提供7x24技术支持
- **腾讯云文档**：https://cloud.tencent.com/document
- **项目GitHub**：提交Issue获取帮助
- **社区支持**：技术论坛和社区群组

---

## 🎉 迁移完成！

恭喜您成功将Jude English Lab从阿里云迁移到腾讯云！

### 💰 成本节省
- 阿里云：约¥100/月
- 腾讯云：约¥24/月
- **每月节省：约¥76**

### 🚀 下一步建议
1. 设置定期备份策略
2. 配置监控告警
3. 优化性能配置
4. 定期更新和维护

### 📈 性能对比
- **配置**：腾讯云2核2G vs 阿里云类似配置
- **价格**：腾讯云更便宜
- **网络**：腾讯云在国内用户访问更快
- **支持**：两家都提供7x24技术支持