# 微信扫码登录功能使用说明

## 功能概述

本项目已成功集成微信扫码登录功能，为学员端用户提供安全便捷的登录体验。用户可以通过微信扫码快速登录，自动保存学习进度和个人数据。

## 技术架构

### 后端实现
- **OAuth2.0 流程**: 实现完整的微信开放平台OAuth2.0授权流程
- **API 接口**: 提供登录授权链接获取、用户信息获取等接口
- **状态管理**: 支持token过期检测和自动刷新
- **安全验证**: 包含state参数防止CSRF攻击

### 前端实现
- **React组件**: 美观的微信登录弹窗和按钮组件
- **响应式设计**: 完美适配移动端和桌面端
- **用户体验**: 加载状态、错误处理、成功反馈
- **状态管理**: 使用Context和Hooks管理用户认证状态

## 主要功能特性

### 1. 微信扫码登录
- 🔐 **安全认证**: 基于微信开放平台OAuth2.0标准
- 📱 **扫码体验**: 支持手机微信扫码快速登录
- 👤 **信息获取**: 自动获取用户昵称、头像等基本信息
- 💾 **状态保存**: 自动保存登录状态，支持持久化

### 2. 用户界面
- 🎨 **现代UI**: 采用TailwindCSS设计的精美界面
- 📱 **响应式**: 完美适配各种屏幕尺寸
- ⚡ **高性能**: 优化的组件加载和交互体验
- 🔄 **实时反馈**: 登录状态实时更新

### 3. 管理功能
- 👤 **用户信息**: 显示用户头像、昵称等基本信息
- 🚪 **退出登录**: 一键退出当前账户
- 🔒 **权限控制**: 基于用户类型的权限管理

## 文件结构

### 后端文件
```
apps/server/src/
├── config/
│   └── env.ts                    # 微信配置变量
├── routes/
│   └── auth.ts                   # 微信OAuth相关API接口
└── ...

# 新增的API接口:
# GET  /api/auth/wechat/auth-url   - 获取微信授权链接
# POST /api/auth/wechat/login      - 微信登录处理
# GET  /api/auth/wechat/callback   - 微信OAuth回调处理
```

### 前端文件
```
apps/web/src/
├── components/
│   ├── WeChatLogin.tsx           # 微信登录弹窗组件
│   ├── WeChatLoginButton.tsx     # 微信登录按钮组件
│   └── AppLayout.tsx             # 集成用户信息的布局组件
├── hooks/
│   └── useAuth.ts                # 用户认证状态管理Hook
├── pages/
│   └── LoginPage.tsx             # 专门的登录页面
└── ...
```

## 配置说明

### 1. 环境变量配置
在 `.env` 文件中添加以下配置：

```env
# 微信开放平台配置
WECHAT_APP_ID=your_wechat_app_id
WECHAT_APP_SECRET=your_wechat_app_secret
WECHAT_REDIRECT_URI=http://localhost:4000/api/auth/wechat/callback
```

### 2. 微信开放平台设置
1. 登录[微信开放平台](https://open.weixin.qq.com/)
2. 创建网站应用
3. 配置授权回调域：`http://localhost:4000`（开发环境）
4. 生产环境需要配置实际的域名

## 使用方法

### 1. 开发环境启动
```bash
# 启动整个项目
pnpm dev

# 单独启动前端
cd apps/web && pnpm dev

# 单独启动后端
cd apps/server && pnpm dev
```

### 2. 访问应用
- **前端地址**: http://localhost:5175
- **后端API**: http://localhost:4000
- **登录页面**: http://localhost:5175/login

### 3. 测试流程
1. 访问登录页面或点击微信登录按钮
2. 点击"点击打开微信登录"
3. 使用微信扫描弹出的二维码
4. 确认授权后自动登录
5. 查看用户信息显示在右上角

## API接口说明

### 获取微信授权链接
```http
GET /api/auth/wechat/auth-url

Response:
{
  "authUrl": "https://open.weixin.qq.com/connect/qrconnect?...",
  "state": "random_state_string"
}
```

### 微信登录处理
```http
POST /api/auth/wechat/login
Content-Type: application/json

{
  "code": "authorization_code",
  "state": "state_string"
}

Response:
{
  "token": "session_token",
  "user": {
    "id": "wechat_openid",
    "openid": "openid",
    "nickname": "用户昵称",
    "headimgurl": "头像URL",
    "loginType": "wechat"
  }
}
```

### 微信OAuth回调
```http
GET /api/auth/wechat/callback?code=xxx&state=xxx
```

## 安全特性

### 1. OAuth安全
- ✅ **State参数**: 防止CSRF攻击
- ✅ **HTTPS通信**: 生产环境强制HTTPS
- ✅ **Token过期**: 支持access_token过期检测
- ✅ **作用域限制**: 仅获取必要的用户信息

### 2. 数据安全
- ✅ **敏感信息保护**: AppSecret仅存储在服务端
- ✅ **会话管理**: 生成安全的随机session token
- ✅ **输入验证**: 严格的数据格式验证
- ✅ **错误处理**: 不泄露敏感信息的错误消息

## 部署指南

### 1. 生产环境配置
```env
# 生产环境微信配置
WECHAT_APP_ID=wx_production_app_id
WECHAT_APP_SECRET=production_app_secret
WECHAT_REDIRECT_URI=https://yourdomain.com/api/auth/wechat/callback
```

### 2. 微信开放平台配置
1. 将生产域名添加到授权回调域
2. 确保网站ICP备案完成
3. 上传网站Logo和资质信息

### 3. 域名和SSL
- 确保域名支持HTTPS
- 配置正确的SSL证书
- 验证回调地址可访问性

## 故障排除

### 常见问题

1. **"微信登录未配置"错误**
   - 检查环境变量是否正确配置
   - 确认微信AppID和AppSecret有效

2. **"获取微信授权失败"错误**
   - 检查授权码是否过期或无效
   - 验证AppSecret是否正确

3. **回调地址不匹配**
   - 确认微信开放平台配置的回调域
   - 检查环境变量中的回调URI

4. **前端无法访问后端API**
   - 检查CORS配置
   - 确认后端服务正常运行

### 调试方法

1. **查看后端日志**
```bash
# 查看服务器日志
cd apps/server && pnpm dev
```

2. **检查网络请求**
- 使用浏览器开发者工具查看网络请求
- 检查API响应状态和错误信息

3. **微信开发者工具**
- 使用微信开发者工具调试OAuth流程
- 查看微信开放平台的调试信息

## 更新日志

### v1.0.0 (2025-01-14)
- ✨ 新增微信扫码登录功能
- ✨ 实现完整的OAuth2.0流程
- ✨ 添加响应式登录界面
- ✨ 集成用户状态管理
- 📚 完善文档和使用说明

## 技术支持

如有问题或建议，请联系开发团队或提交Issue。

---

**注意**: 微信扫码登录功能需要在微信开放平台创建网站应用并获得相应的AppID和AppSecret才能正常使用。测试时可以使用开发者账号进行调试。