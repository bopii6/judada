# 服务器故障排查脚本

## 1. 检查Nginx状态
```bash
# 检查Nginx是否运行
sudo systemctl status nginx

# 如果没有运行，启动Nginx
sudo systemctl start nginx

# 检查Nginx配置是否有语法错误
sudo nginx -t

# 如果配置有误，重新加载配置
sudo systemctl reload nginx

# 查看Nginx错误日志
sudo tail -f /var/log/nginx/error.log
```

## 2. 检查Node.js应用状态
```bash
# 检查Node.js进程是否在运行
ps aux | grep node

# 检查特定端口是否被占用（假设您的应用运行在4000端口）
sudo netstat -tlnp | grep :4000

# 或者使用ss命令
sudo ss -tlnp | grep :4000

# 如果没有进程在运行，检查应用目录
ls -la /path/to/your/app

# 查看应用日志
tail -f /path/to/your/app/logs/app.log
```

## 3. 检查系统资源
```bash
# 检查内存使用情况
free -h

# 检查磁盘空间
df -h

# 检查CPU使用情况
top

# 检查系统负载
uptime
```

## 4. 检查防火墙设置
```bash
# 检查防火墙状态
sudo ufw status

# 或者如果使用iptables
sudo iptables -L

# 检查端口是否开放
sudo ufw allow 4000
sudo ufw allow 80
sudo ufw allow 443
```

## 5. 重启服务
```bash
# 重启Node.js应用（如果使用PM2）
pm2 restart all

# 或者如果使用systemd服务
sudo systemctl restart your-app-service

# 重启Nginx
sudo systemctl restart nginx
```

## 6. 检查域名解析
```bash
# 检查DNS解析
nslookup yourdomain.com
dig yourdomain.com

# 检查hosts文件
cat /etc/hosts
```

## 7. 常见问题解决方案

### 问题1：内存不足导致应用崩溃
```bash
# 创建swap文件
sudo fallocate -l 2G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile

# 永久启用swap
echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
```

### 问题2：端口被占用
```bash
# 查找占用端口的进程
sudo lsof -i :4000

# 终止进程
sudo kill -9 PID
```

### 问题3：权限问题
```bash
# 检查文件权限
ls -la /path/to/your/app

# 修改权限
sudo chown -R user:group /path/to/your/app
sudo chmod -R 755 /path/to/your/app
```

## 8. 快速诊断脚本
```bash
#!/bin/bash
echo "=== 系统状态检查 ==="
echo "时间: $(date)"
echo "负载: $(uptime)"
echo "内存: $(free -h | grep Mem)"
echo "磁盘: $(df -h /)"

echo -e "\n=== Nginx状态 ==="
sudo systemctl is-active nginx
sudo nginx -t

echo -e "\n=== Node.js进程 ==="
ps aux | grep node | grep -v grep

echo -e "\n=== 端口监听 ==="
sudo ss -tlnp | grep -E ':(80|443|4000|3000)'

echo -e "\n=== 近期错误日志 ==="
sudo tail -5 /var/log/nginx/error.log
```